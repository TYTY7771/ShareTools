{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ShareTools - Sign in to your account">
    <meta name="keywords" content="login,ShareTools,tool sharing">
    <title>Sign In - ShareTools</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="{% static 'css/main.css' %}" as="style">
    <link rel="preload" href="{% static 'css/components.css' %}" as="style">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/components.css' %}">
    <link rel="stylesheet" href="{% static 'css/login.css' %}">
    
    <!-- BoxIcons icon library -->
    <link href='https://cdn.jsdelivr.net/npm/boxicons@2.0.5/css/boxicons.min.css' rel='stylesheet'>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🔧</text></svg>">
</head>
<body>
    <!-- Navigation -->
    <header class="header" role="banner">
        <div class="container">
            <div class="header-content">
                <!-- Logo Area -->
                <a href="{% url 'home' %}" class="logo" aria-label="ShareTools Home">
                    <img src="{% static 'images/ShareTools Web Logo.png' %}" alt="ShareTools Logo" class="logo-image">
                    <span>ShareTools</span>
                </a>
                
                <!-- Navigation Menu -->
                <nav class="nav-menu" role="navigation" aria-label="Main Navigation">
                    <ul>
                        <li class="nav-item">
                            <a href="{% url 'browse_things' %}" class="nav-link">The Things</a>
                        </li>
                        <li class="nav-item nav-dropdown">
                            <a href="{% url 'locations' %}" class="nav-link">Locations</a>
                            <div class="dropdown-menu">
                                <div class="dropdown-content">
                                    <div class="dropdown-section">
                                        <h4 class="dropdown-section-title">NORTH GLASGOW</h4>
                                        <ul class="dropdown-list">
                                            <li><a href="{% url 'browse_things' %}?location=maryhill" class="dropdown-link">Maryhill</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=hillhead" class="dropdown-link">Hillhead</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=partick" class="dropdown-link">Partick</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=springburn" class="dropdown-link">Springburn</a></li>
                                        </ul>
                                    </div>
                                    <div class="dropdown-section">
                                        <h4 class="dropdown-section-title">SOUTH GLASGOW</h4>
                                        <ul class="dropdown-list">
                                            <li><a href="{% url 'browse_things' %}?location=gorbals" class="dropdown-link">Gorbals</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=pollokshields" class="dropdown-link">Pollokshields</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=shawlands" class="dropdown-link">Shawlands</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=giffnock" class="dropdown-link">Giffnock</a></li>
                                        </ul>
                                    </div>
                                    <div class="dropdown-section">
                                        <h4 class="dropdown-section-title">EAST GLASGOW</h4>
                                        <ul class="dropdown-list">
                                            <li><a href="{% url 'browse_things' %}?location=dennistoun" class="dropdown-link">Dennistoun</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=bridgeton" class="dropdown-link">Bridgeton</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=calton" class="dropdown-link">Calton</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=parkhead" class="dropdown-link">Parkhead</a></li>
                                        </ul>
                                    </div>
                                    <div class="dropdown-section">
                                        <h4 class="dropdown-section-title">WEST GLASGOW</h4>
                                        <ul class="dropdown-list">
                                            <li><a href="{% url 'browse_things' %}?location=finnieston" class="dropdown-link">Finnieston</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=kelvingrove" class="dropdown-link">Kelvingrove</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=byres-road" class="dropdown-link">Byres Road</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a href="{% url 'about' %}" class="nav-link">About</a>
                        </li>
                        <li class="nav-item">
                            <a href="{% url 'list_item' %}" class="nav-link">List an Item</a>
                        </li>
                    </ul>
                </nav>
                
                <!-- User Actions -->
                <div class="nav-actions">
                    <button class="cart-icon" aria-label="Shopping Cart" title="View Cart">
                        🛒
                    </button>
                    
                    <!-- Guest user actions -->
                    <div id="guest-actions" class="user-state-actions">
                        <a href="{% url 'login' %}" class="btn btn-secondary">Sign in</a>
                        <a href="{% url 'login' %}#signup" class="btn btn-primary">Join</a>
                    </div>
                    
                    <!-- Logged in user actions -->
                    <div id="logged-in-actions" class="user-state-actions" style="display: none;">
                        <a href="{% url 'profile' %}" class="btn btn-secondary">Profile</a>
                        <a href="{% url 'list_item' %}" class="btn btn-primary">List an Item</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="login-main" role="main">
        <div class="login-container">
            <div class="login-content">
                <!-- Left Illustration Area -->
                <div class="login-illustration">
                    <div class="illustration-container">
                        <svg width="400" height="400" viewBox="0 0 400 400" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <!-- Background gradient -->
                            <defs>
                                <linearGradient id="bgGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#F9F9F9"/>
                                    <stop offset="100%" style="stop-color:#E8F4FD"/>
                                </linearGradient>
                                <linearGradient id="toolGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#2879FF"/>
                                    <stop offset="100%" style="stop-color:#4A93FF"/>
                                </linearGradient>
                            </defs>
                            
                            <!-- Background -->
                            <rect width="400" height="400" fill="url(#bgGradient)" rx="16"/>
                            
                            <!-- Main graphic - toolbox -->
                            <rect x="100" y="180" width="200" height="120" fill="url(#toolGradient)" rx="12"/>
                            <rect x="110" y="190" width="180" height="20" fill="#FFFFFF" rx="6" opacity="0.3"/>
                            
                            <!-- Tool icons -->
                            <circle cx="150" cy="240" r="18" fill="#FFFFFF"/>
                            <path d="M142 232 L158 248 M158 232 L142 248" stroke="#2879FF" stroke-width="3" stroke-linecap="round"/>
                            
                            <circle cx="200" cy="240" r="18" fill="#FFFFFF"/>
                            <rect x="192" y="232" width="16" height="16" fill="#2879FF" rx="3"/>
                            
                            <circle cx="250" cy="240" r="18" fill="#FFFFFF"/>
                            <circle cx="250" cy="240" r="10" fill="#2879FF"/>
                            
                            <!-- Decorative elements -->
                            <circle cx="80" cy="80" r="6" fill="#27AE60" opacity="0.8"/>
                            <circle cx="320" cy="100" r="8" fill="#E2B93B" opacity="0.8"/>
                            <circle cx="350" cy="300" r="7" fill="#E04E4E" opacity="0.8"/>
                            
                            <!-- Floating tools -->
                            <g transform="translate(60, 120)">
                                <circle cx="0" cy="0" r="16" fill="#FFFFFF" stroke="#2879FF" stroke-width="3"/>
                                <text x="0" y="6" text-anchor="middle" font-size="16" fill="#2879FF">🔧</text>
                            </g>
                            
                            <g transform="translate(320, 140)">
                                <circle cx="0" cy="0" r="14" fill="#FFFFFF" stroke="#27AE60" stroke-width="3"/>
                                <text x="0" y="5" text-anchor="middle" font-size="14" fill="#27AE60">⚙️</text>
                            </g>
                            
                            <!-- Connection lines -->
                            <path d="M150 100 Q200 120 250 100" stroke="#2879FF" stroke-width="2" fill="none" opacity="0.4" stroke-dasharray="5,5"/>
                            <path d="M100 150 Q150 170 200 150" stroke="#4A93FF" stroke-width="2" fill="none" opacity="0.4" stroke-dasharray="5,5"/>
                        </svg>
                        
                        <div class="illustration-text">
                            <h2>Welcome back to ShareTools</h2>
                            <p>Connect communities, share tools, make life easier</p>
                        </div>
                    </div>
                </div>

                <!-- Right Form Area -->
                <div class="login-forms">
                    <!-- Sign In Form -->
                    <form class="auth-form" id="signin-form">
                        <h1 class="auth-title">Sign In</h1>
                        
                        <div class="form-group">
                            <div class="input-box">
                                <i class='bx bx-user input-icon'></i>
                                <input type="text" name="username" placeholder="Username or Email" class="form-input" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="input-box">
                                <i class='bx bx-lock-alt input-icon'></i>
                                <input type="password" name="password" placeholder="Password" class="form-input" required>
                            </div>
                        </div>
                        
                        <div class="form-options">
                            <label class="remember-me">
                                <input type="checkbox" class="checkbox">
                                <span class="checkmark"></span>
                                Remember me
                            </label>
                            <a href="#forgot" class="forgot-link">Forgot password?</a>
                        </div>
                        
                        <button type="submit" class="auth-button">Sign In</button>
                        
                        <div class="auth-switch">
                            <span class="switch-text">Don't have an account?</span>
                            <button type="button" class="switch-button" id="show-signup">Sign Up</button>
                        </div>
                    </form>

                    <!-- Sign Up Form -->
                    <form class="auth-form hidden" id="signup-form">
                        <h1 class="auth-title">Create Account</h1>
                        
                        <div class="form-group">
                            <div class="input-box">
                                <i class='bx bx-user input-icon'></i>
                                <input type="text" name="username" placeholder="Username" class="form-input" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="input-box">
                                <i class='bx bx-envelope input-icon'></i>
                                <input type="email" name="email" placeholder="Email Address" class="form-input" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="input-box">
                                <i class='bx bx-lock-alt input-icon'></i>
                                <input type="password" name="password" placeholder="Password" class="form-input" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="input-box">
                                <i class='bx bx-lock input-icon'></i>
                                <input type="password" name="password_confirm" placeholder="Confirm Password" class="form-input" required>
                            </div>
                        </div>
                        
                        <div class="form-options">
                            <label class="remember-me">
                                <input type="checkbox" class="checkbox" required>
                                <span class="checkmark"></span>
                                I agree to the <a href="#terms" class="terms-link">Terms of Service</a> and <a href="#privacy" class="terms-link">Privacy Policy</a>
                            </label>
                        </div>
                        
                        <button type="submit" class="auth-button">Sign Up</button>
                        
                        <div class="auth-switch">
                            <span class="switch-text">Already have an account?</span>
                            <button type="button" class="switch-button" id="show-signin">Sign In</button>
                        </div>
                        
                        <div class="social-login">
                            <div class="divider">
                                <span>Or sign up with</span>
                            </div>
                            <div class="social-buttons">
                                <a href="#google" class="social-button google">
                                    <i class='bx bxl-google'></i>
                                    <span>Google</span>
                                </a>
                                <a href="#github" class="social-button github">
                                    <i class='bx bxl-github'></i>
                                    <span>GitHub</span>
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="login-footer" role="contentinfo">
        <div class="container">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="{% url 'home' %}">Home</a>
                    <a href="#help">Help Center</a>
                    <a href="#privacy">Privacy Policy</a>
                    <a href="#terms">Terms of Service</a>
                    <a href="#contact">Contact Us</a>
                </div>
                <div class="footer-copyright">
                    <p>© 2025 ShareTools. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript files -->
    <script src="{% static 'js/components.js' %}"></script>
    <script src="{% static 'js/api-config.js' %}"></script>
    <script src="{% static 'js/main.js' %}"></script>
    
    <!-- User state management styles and scripts -->
    <style>
        /* User state related styles */
        .user-state-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .user-state-actions .btn {
            transition: all 0.3s ease;
        }
        
        /* Login state transition animations */
        .user-state-actions.fade-out {
            opacity: 0;
            transform: translateX(10px);
        }
        
        .user-state-actions.fade-in {
            opacity: 1;
            transform: translateX(0);
        }
    </style>
    
    <!-- User state management script -->
    <script>
        // User login state management
        class UserAuthManager {
            constructor() {
                this.storageKey = 'sharetools_user_logged_in';
                this.userDataKey = 'sharetools_user_data';
                this.init();
            }

            // Initialize
            init() {
                this.updateNavigation();
                this.bindEvents();
                console.log('User authentication manager initialized');
            }

            // Check if user is logged in
            isLoggedIn() {
                // Check login status in localStorage
                const loginStatus = localStorage.getItem(this.storageKey);
                const userData = localStorage.getItem(this.userDataKey);
                
                // Check sessionStorage (for session-level login status)
                const sessionLogin = sessionStorage.getItem(this.storageKey);
                
                return (loginStatus === 'true' && userData) || sessionLogin === 'true';
            }

            // Set login status
            setLoginStatus(isLoggedIn, userData = null, rememberMe = false) {
                if (isLoggedIn) {
                    // Set login status
                    if (rememberMe) {
                        localStorage.setItem(this.storageKey, 'true');
                        if (userData) {
                            localStorage.setItem(this.userDataKey, JSON.stringify(userData));
                        }
                    } else {
                        // Keep login only during session
                        sessionStorage.setItem(this.storageKey, 'true');
                        if (userData) {
                            sessionStorage.setItem(this.userDataKey, JSON.stringify(userData));
                        }
                    }
                    console.log('User login status set');
                } else {
                    // Clear login status
                    localStorage.removeItem(this.storageKey);
                    localStorage.removeItem(this.userDataKey);
                    sessionStorage.removeItem(this.storageKey);
                    sessionStorage.removeItem(this.userDataKey);
                    console.log('User login status cleared');
                }
                
                this.updateNavigation();
            }

            // Get user data
            getUserData() {
                const localData = localStorage.getItem(this.userDataKey);
                const sessionData = sessionStorage.getItem(this.userDataKey);
                
                if (localData) {
                    try {
                        return JSON.parse(localData);
                    } catch (e) {
                        console.error('Failed to parse user data:', e);
                    }
                }
                
                if (sessionData) {
                    try {
                        return JSON.parse(sessionData);
                    } catch (e) {
                        console.error('Failed to parse session user data:', e);
                    }
                }
                
                return null;
            }

            // Update navigation display
            updateNavigation() {
                const guestActions = document.getElementById('guest-actions');
                const loggedInActions = document.getElementById('logged-in-actions');
                
                if (!guestActions || !loggedInActions) {
                    console.warn('Navigation elements not found');
                    return;
                }

                const isLoggedIn = this.isLoggedIn();
                
                if (isLoggedIn) {
                    // Show logged in navigation
                    this.showElement(loggedInActions);
                    this.hideElement(guestActions);
                    console.log('Showing logged in navigation state');
                } else {
                    // Show guest navigation
                    this.showElement(guestActions);
                    this.hideElement(loggedInActions);
                    console.log('Showing guest navigation state');
                }
            }

            // Show element (with animation)
            showElement(element) {
                element.style.display = 'flex';
                element.classList.remove('fade-out');
                element.classList.add('fade-in');
            }

            // Hide element (with animation)
            hideElement(element) {
                element.classList.remove('fade-in');
                element.classList.add('fade-out');
                setTimeout(() => {
                    element.style.display = 'none';
                }, 300);
            }

            // Bind events
            bindEvents() {
                // Listen for storage changes (cross-tab sync)
                window.addEventListener('storage', (e) => {
                    if (e.key === this.storageKey || e.key === this.userDataKey) {
                        console.log('Detected cross-tab login status change');
                        this.updateNavigation();
                    }
                });

                // Listen for custom login events
                window.addEventListener('userLogin', (e) => {
                    console.log('Received user login event:', e.detail);
                    this.setLoginStatus(true, e.detail.userData, e.detail.rememberMe);
                });

                // Listen for custom logout events
                window.addEventListener('userLogout', () => {
                    console.log('Received user logout event');
                    this.setLoginStatus(false);
                });
            }
        }

        // Initialize user authentication manager
        let userAuthManager;
        document.addEventListener('DOMContentLoaded', () => {
            userAuthManager = new UserAuthManager();
            window.userAuthManager = userAuthManager;
        });
    </script>
    
    <!-- Login functionality logic -->
    <script>
        // Login form handling
        document.addEventListener('DOMContentLoaded', function() {
            const signinForm = document.getElementById('signin-form');
            const signupForm = document.getElementById('signup-form');
            const showSignupBtn = document.getElementById('show-signup');
            const showSigninBtn = document.getElementById('show-signin');

            // Form switching functionality
            showSignupBtn.addEventListener('click', function(e) {
                e.preventDefault();
                signinForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
            });

            showSigninBtn.addEventListener('click', function(e) {
                e.preventDefault();
                signupForm.classList.add('hidden');
                signinForm.classList.remove('hidden');
            });

            // Check URL hash, if #signup, show registration form
            if (window.location.hash === '#signup') {
                signinForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
            }

            // Login form submit handling
            signinForm.addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin(e);
            });

            // Registration form submit handling
            signupForm.addEventListener('submit', function(e) {
                e.preventDefault();
                handleSignup(e);
            });
        });

        // Handle login
        async function handleLogin(event) {
            event.preventDefault();
            
            const form = event.target;
            const email = form.querySelector('input[name="username"]').value;
            const password = form.querySelector('input[name="password"]').value;
            const rememberMe = form.querySelector('input[type="checkbox"]').checked;
            
            console.log('Login attempt:', { email, rememberMe });
            
            // Basic validation
            if (!email || !password) {
                alert('Please fill in username/email and password');
                return;
            }
            
            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Signing in...';
            submitBtn.disabled = true;
            
            try {
                // Call real API
                const response = await AuthAPI.login(email, password);
                
                // Validate response
                if (response && response.success && response.user) {
                    console.log('Login successful, user data:', response.user);
                    
                    // Trigger custom login event, let UserAuthManager handle state management
                    window.dispatchEvent(new CustomEvent('userLogin', {
                        detail: { userData: response.user, rememberMe: rememberMe }
                    }));
                    
                    alert('Login successful! Redirecting to homepage...');
                    
                    // Redirect to homepage - use absolute path
                    setTimeout(() => {
                        window.location.href = window.location.origin + '/';
                    }, 1000);
                } else {
                    // Login failed
                    throw new Error(response.message || 'Login failed, please check username and password');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Login failed, please check your email and password';
                
                // Handle specific error messages
                if (error.message) {
                    errorMessage = error.message;
                } else if (error.status === 401) {
                    errorMessage = 'Email or password incorrect';
                } else if (error.status === 400) {
                    errorMessage = 'Request parameter error';
                } else if (error.status === 500) {
                    errorMessage = 'Server error, please try again later';
                }
                
                alert(errorMessage);
            } finally {
                // Reset button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // Handle registration
        async function handleSignup(event) {
            event.preventDefault();
            
            const form = event.target;
            const username = form.querySelector('input[name="username"]').value;
            const email = form.querySelector('input[name="email"]').value;
            const password = form.querySelector('input[placeholder="Password"]').value;
            const confirmPassword = form.querySelector('input[name="password_confirm"]').value;
            const agreeTerms = form.querySelector('input[type="checkbox"]').checked;
            
            console.log('Registration attempt:', { username, email });
            
            // Basic validation
            if (!username || !email || !password || !confirmPassword) {
                alert('Please fill in all required information');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('The two passwords entered do not match');
                return;
            }
            
            if (!agreeTerms) {
                alert('Please read and agree to the Terms of Service and Privacy Policy');
                return;
            }
            
            // Email format validation
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailPattern.test(email)) {
                alert('Please enter a valid email address');
                return;
            }
            
            // Password strength validation
            if (password.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }
            
            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating account...';
            submitBtn.disabled = true;
            
            try {
                // Call real API
                const response = await AuthAPI.register(username, email, password, confirmPassword);
                
                // Validate response
                if (response && response.success && response.user) {
                    console.log('Registration successful, user data:', response.user);
                    
                    // Trigger custom login event, let UserAuthManager handle state management
                    window.dispatchEvent(new CustomEvent('userLogin', {
                        detail: { userData: response.user, rememberMe: false }
                    }));
                    
                    alert('Registration successful! Redirecting to homepage...');
                    
                    // Redirect to homepage - use absolute path
                    setTimeout(() => {
                        window.location.href = window.location.origin + '/';
                    }, 1000);
                } else {
                    // Registration failed
                    throw new Error(response.message || 'Registration failed, please try again later');
                }
                
            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = 'Registration failed, please try again later';
                
                // Handle specific error messages
                if (error.message) {
                    errorMessage = error.message;
                } else if (error.status === 400) {
                    errorMessage = 'Username or email already exists, or request parameter error';
                } else if (error.status === 500) {
                    errorMessage = 'Server error, please try again later';
                }
                
                alert(errorMessage);
            } finally {
                // Reset button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // Page load performance monitoring
        window.addEventListener('load', () => {
            if ('performance' in window) {
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                console.log(`Login page load time: ${loadTime}ms`);
            }
        });
        
        // Error monitoring
        window.addEventListener('error', (e) => {
            console.error('Login page error:', e.error);
        });
    </script>
</body>
</html>