{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ShareTools - Publish your items, share idle tools with the community">
    <meta name="keywords" content="publish items,tool sharing,item rental,ShareTools">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Publish Item - ShareTools</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="{% static 'css/main.css' %}" as="style">
    <link rel="preload" href="{% static 'css/components.css' %}" as="style">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/components.css' %}">
    <link rel="stylesheet" href="{% static 'css/list_item.css' %}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîß</text></svg>">
    
    <!-- API Configuration - load first -->
    <script src="{% static 'js/api-config.js' %}"></script>
</head>
<body>
    <!-- Navigation -->
    <header class="header" role="banner">
        <div class="container">
            <div class="header-content">
                <!-- Logo Area -->
                <a href="{% url 'home' %}" class="logo" aria-label="ShareTools Home">
                    <img src="{% static 'images/ShareTools Web Logo.png' %}" alt="ShareTools Logo" class="logo-image">
                    <span>ShareTools</span>
                </a>
                
                <!-- Navigation Menu -->
                <nav class="nav-menu" role="navigation" aria-label="Main Navigation">
                    <ul>
                        <li class="nav-item">
                            <a href="{% url 'browse_things' %}" class="nav-link">The Things</a>
                        </li>
                        <li class="nav-item nav-dropdown">
                            <a href="{% url 'locations' %}" class="nav-link">Locations</a>
                            <div class="dropdown-menu">
                                <div class="dropdown-content">
                                    <div class="dropdown-section">
                                        <h4 class="dropdown-section-title">NORTH GLASGOW</h4>
                                        <ul class="dropdown-list">
                                            <li><a href="{% url 'browse_things' %}?location=maryhill" class="dropdown-link">Maryhill</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=hillhead" class="dropdown-link">Hillhead</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=partick" class="dropdown-link">Partick</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=springburn" class="dropdown-link">Springburn</a></li>
                                        </ul>
                                    </div>
                                    <div class="dropdown-section">
                                        <h4 class="dropdown-section-title">SOUTH GLASGOW</h4>
                                        <ul class="dropdown-list">
                                            <li><a href="{% url 'browse_things' %}?location=gorbals" class="dropdown-link">Gorbals</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=pollokshields" class="dropdown-link">Pollokshields</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=shawlands" class="dropdown-link">Shawlands</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=giffnock" class="dropdown-link">Giffnock</a></li>
                                        </ul>
                                    </div>
                                    <div class="dropdown-section">
                                        <h4 class="dropdown-section-title">EAST GLASGOW</h4>
                                        <ul class="dropdown-list">
                                            <li><a href="{% url 'browse_things' %}?location=dennistoun" class="dropdown-link">Dennistoun</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=bridgeton" class="dropdown-link">Bridgeton</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=calton" class="dropdown-link">Calton</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=parkhead" class="dropdown-link">Parkhead</a></li>
                                        </ul>
                                    </div>
                                    <div class="dropdown-section">
                                        <h4 class="dropdown-section-title">WEST GLASGOW</h4>
                                        <ul class="dropdown-list">
                                            <li><a href="{% url 'browse_things' %}?location=finnieston" class="dropdown-link">Finnieston</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=kelvingrove" class="dropdown-link">Kelvingrove</a></li>
                                            <li><a href="{% url 'browse_things' %}?location=byres-road" class="dropdown-link">Byres Road</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a href="{% url 'about' %}" class="nav-link">About</a>
                        </li>
                        <li class="nav-item">
                            <a href="{% url 'list_item' %}" class="nav-link">List an Item</a>
                        </li>
                    </ul>
                </nav>
                
                <!-- User Actions -->
                <div class="nav-actions">
                    <button class="cart-icon" aria-label="Shopping Cart" title="View Cart">
                        üõí
                    </button>
                    
                    <!-- Buttons for guest state -->
                    <div id="guest-actions" class="user-state-actions">
                        <a href="{% url 'login' %}" class="btn btn-secondary">Sign in</a>
                        <a href="{% url 'login' %}#signup" class="btn btn-primary">Join</a>
                    </div>
                    
                    <!-- Buttons for logged-in state -->
                    <div id="logged-in-actions" class="user-state-actions" style="display: none;">
                        <a href="{% url 'profile' %}" class="btn btn-secondary">Profile</a>
                        <a href="{% url 'list_item' %}" class="btn btn-primary">List an Item</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main role="main" class="main-content">
        <!-- Form Section -->
        <div class="form-section">
            <!-- Header -->
            <div class="list-item-header">
                <h1 class="list-item-title">List your item</h1>
            </div>
            
            <!-- Form start -->
            <form id="list-item-form" enctype="multipart/form-data">

            <!-- Step 1: Select Category -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <h2 class="step-title">Select category</h2>
                </div>
                
                <div class="form-group">
                    <div class="category-dropdown">
                        <select class="form-input" id="category" name="category">
                            <option value="">Choose a category...</option>
                            <option value="tools">Tools</option>
                            <option value="electronics">Electronics</option>
                            <option value="garden">Garden Equipment</option>
                            <option value="sports">Sports Equipment</option>
                            <option value="automotive">Automotive</option>
                            <option value="home">Home & DIY</option>
                        </select>
                        <div class="dropdown-arrow">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="guarantee-info">Guarantee information for <span id="selected-category">selected category</span>:</div>
                <div class="guarantee-details">Claims are covered up to ¬£1000 without any excess.</div>
            </div>

            <!-- Step 2: Describe Your Item -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <h2 class="step-title">Describe your item</h2>
                </div>
                
                <div class="form-group">
                    <label for="title" class="form-label">Title</label>
                    <input type="text" id="title" name="title" class="form-input" placeholder="Enter item title">
                </div>
                
                <div class="form-group">
                    <label for="description" class="form-label">Describe the item in as much detail as possible</label>
                    <textarea id="description" name="description" class="form-input form-textarea" placeholder="Provide detailed description of your item..."></textarea>
                </div>
            </div>

            <!-- Step 3: Pictures -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <h2 class="step-title">Pictures</h2>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Upload pictures in landscape format (4:3)</label>
                    <p class="info-text">In order for the pictures to look good, they should be landscaped. Portrait picture will not be fully displayed.</p>
                    
                    <div class="upload-grid">
                        <div class="upload-slot" onclick="document.getElementById('file-input-1').click()">
                            <svg class="upload-icon" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 15V3" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <input type="file" id="file-input-1" accept="image/*" style="display: none;">
                        </div>
                        <div class="upload-slot" onclick="document.getElementById('file-input-2').click()">
                            <svg class="upload-icon" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 15V3" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <input type="file" id="file-input-2" accept="image/*" style="display: none;">
                        </div>
                        <div class="upload-slot" onclick="document.getElementById('file-input-3').click()">
                            <svg class="upload-icon" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 15V3" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <input type="file" id="file-input-3" accept="image/*" style="display: none;">
                        </div>
                        <div class="upload-slot" onclick="document.getElementById('file-input-4').click()">
                            <svg class="upload-icon" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 15V3" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <input type="file" id="file-input-4" accept="image/*" style="display: none;">
                        </div>
                        <div class="upload-slot" onclick="document.getElementById('file-input-5').click()">
                            <svg class="upload-icon" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 15V3" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <input type="file" id="file-input-5" accept="image/*" style="display: none;">
                        </div>
                        <div class="upload-slot" onclick="document.getElementById('file-input-6').click()">
                            <svg class="upload-icon" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 15V3" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <input type="file" id="file-input-6" accept="image/*" style="display: none;">
                        </div>
                        <div class="upload-slot" onclick="document.getElementById('file-input-7').click()">
                            <svg class="upload-icon" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 15V3" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <input type="file" id="file-input-7" accept="image/*" style="display: none;">
                        </div>
                        <div class="upload-slot" onclick="document.getElementById('file-input-8').click()">
                            <svg class="upload-icon" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 15V3" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <input type="file" id="file-input-8" accept="image/*" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Price -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <h2 class="step-title">Price</h2>
                </div>
                
                <p class="info-text">You can offer lower prices for longer bookings. The rental price is calculated according to the lowest possible price level.</p>
                
                <div class="price-grid">
                    <div class="form-group">
                        <label for="price-1day" class="form-label">Price for 1 day (required)</label>
                        <div class="price-input-group">
                            <span class="currency">¬£</span>
                            <input type="number" id="price-1day" name="price-1day" class="form-input" placeholder="0.00" step="0.01" min="0.5" max="1000">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="price-3days" class="form-label">Price for 3 days</label>
                        <div class="price-input-group">
                            <span class="currency">¬£</span>
                            <input type="number" id="price-3days" name="price-3days" class="form-input" placeholder="0.00" step="0.01" min="1" max="3000">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="price-7days" class="form-label">Price for 7 days</label>
                        <div class="price-input-group">
                            <span class="currency">¬£</span>
                            <input type="number" id="price-7days" name="price-7days" class="form-input" placeholder="0.00" step="0.01" min="2" max="7000">
                        </div>
                    </div>
                </div>
                
                <div class="price-suggestions">
                    <h4>Price suggestions for <span id="category-name">xxx</span></h4>
                    <div class="price-suggestion-item">
                        <span>Price per day:</span>
                        <span>¬£<span id="suggest-1day">0.00</span></span>
                    </div>
                    <div class="price-suggestion-item">
                        <span>Price for 3 days:</span>
                        <span>¬£<span id="suggest-3days">0.00</span></span>
                    </div>
                    <div class="price-suggestion-item">
                        <span>Price for 7 days:</span>
                        <span>¬£<span id="suggest-7days">0.00</span></span>
                    </div>
                </div>
                
                <button type="button" class="btn-suggestion" onclick="usePriceSuggestions()">Use price suggestions</button>
            </div>

            <!-- Step 5: Location -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-number">5</div>
                    <h2 class="step-title">Where can the item be handed over?</h2>
                </div>
                
                <p class="info-text">Your exact address will not be shown before the rentals is paid and verified.</p>
                
                <div class="form-group">
                    <label for="location" class="form-label">Select location area</label>
                    <div class="category-dropdown">
                        <select class="form-input" id="location" name="location">
                            <option value="">Choose a location...</option>
                            <optgroup label="NORTH GLASGOW">
                                <option value="maryhill">Maryhill</option>
                                <option value="hillhead">Hillhead</option>
                                <option value="partick">Partick</option>
                                <option value="springburn">Springburn</option>
                            </optgroup>
                            <optgroup label="SOUTH GLASGOW">
                                <option value="gorbals">Gorbals</option>
                                <option value="pollokshields">Pollokshields</option>
                                <option value="shawlands">Shawlands</option>
                                <option value="giffnock">Giffnock</option>
                            </optgroup>
                            <optgroup label="EAST GLASGOW">
                                <option value="dennistoun">Dennistoun</option>
                                <option value="bridgeton">Bridgeton</option>
                                <option value="calton">Calton</option>
                                <option value="parkhead">Parkhead</option>
                            </optgroup>
                            <optgroup label="WEST GLASGOW">
                                <option value="finnieston">Finnieston</option>
                                <option value="kelvingrove">Kelvingrove</option>
                                <option value="byres-road">Byres Road</option>
                            </optgroup>
                        </select>
                        <div class="dropdown-arrow">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="address" class="form-label">Detailed address</label>
                    <input type="text" id="address" name="address" class="form-input" placeholder="Enter your detailed address">
                </div>
            </div>

            <!-- Step 6: Value -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-number">6</div>
                    <h2 class="step-title">Value of item</h2>
                </div>
                
                <div class="form-group">
                    <div class="value-input-group">
                        <span class="currency">¬£</span>
                        <input type="number" id="item-value" name="item-value" class="form-input" placeholder="0.00" step="0.01">
                    </div>
                </div>
                
                <p class="info-text">If you would sell it today on e.g. Facebook Marketplace - what would it be worth?</p>
                
                <a href="#" class="read-more-link">Read more about item valuation</a>
            </div>

            <!-- Publish Button -->
            <button type="submit" class="publish-btn">Publish listing!</button>
            </form>
            <!-- Form end -->
        </div>

        <!-- Sidebar -->
        <div class="sidebar-info">
            <div class="sidebar-logo">
                üîß
            </div>
            <p class="sidebar-text">
                Join the sharing action<br><br>
                üíú Rent, share, and exchange various idle items with local partners<br><br>
                üìåLearn maintenance, DIY and other skills to avoid waste by renting equipment
            </p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="section" style="background: var(--color-secondary); color: var(--color-accent); padding: var(--spacing-2xl) 0;" role="contentinfo">
        <div class="container">
            <div class="grid grid-4" style="gap: var(--spacing-xl);">
                <!-- Company Info -->
                <div>
                    <div class="logo" style="color: var(--color-accent); margin-bottom: var(--spacing-md);">
                        <div class="logo-icon">üîß</div>
                        <span>ShareTools</span>
                    </div>
                    <p style="color: var(--color-secondary-tint); font-size: var(--font-size-caption);">
                        Making tool sharing simple, safe, and sustainable for everyone.
                    </p>
                </div>
                
                <!-- Quick Links -->
                <div>
                    <h3 style="color: var(--color-accent); margin-bottom: var(--spacing-md);">Quick Links</h3>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: var(--spacing-xs);"><a href="#" style="color: var(--color-secondary-tint); text-decoration: none;">How it works</a></li>
                        <li style="margin-bottom: var(--spacing-xs);"><a href="#" style="color: var(--color-secondary-tint); text-decoration: none;">Safety</a></li>
                        <li style="margin-bottom: var(--spacing-xs);"><a href="#" style="color: var(--color-secondary-tint); text-decoration: none;">Insurance</a></li>
                        <li style="margin-bottom: var(--spacing-xs);"><a href="#" style="color: var(--color-secondary-tint); text-decoration: none;">Support</a></li>
                    </ul>
                </div>
                
                <!-- Community -->
                <div>
                    <h3 style="color: var(--color-accent); margin-bottom: var(--spacing-md);">Community</h3>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: var(--spacing-xs);"><a href="#" style="color: var(--color-secondary-tint); text-decoration: none;">Blog</a></li>
                        <li style="margin-bottom: var(--spacing-xs);"><a href="#" style="color: var(--color-secondary-tint); text-decoration: none;">Forum</a></li>
                        <li style="margin-bottom: var(--spacing-xs);"><a href="#" style="color: var(--color-secondary-tint); text-decoration: none;">Events</a></li>
                        <li style="margin-bottom: var(--spacing-xs);"><a href="#" style="color: var(--color-secondary-tint); text-decoration: none;">Newsletter</a></li>
                    </ul>
                </div>
                
                <!-- Contact -->
                <div>
                    <h3 style="color: var(--color-accent); margin-bottom: var(--spacing-md);">Contact</h3>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: var(--spacing-xs); color: var(--color-secondary-tint); font-size: var(--font-size-caption);">üìß hello@sharetools.com</li>
                        <li style="margin-bottom: var(--spacing-xs); color: var(--color-secondary-tint); font-size: var(--font-size-caption);">üìû +44 1234567-213</li>
                        <li style="margin-bottom: var(--spacing-xs); color: var(--color-secondary-tint); font-size: var(--font-size-caption);">üìç </li>
                    </ul>
                </div>
            </div>
            
            <!-- Copyright -->
            <div style="border-top: 1px solid var(--color-secondary-tint); margin-top: var(--spacing-xl); padding-top: var(--spacing-lg); text-align: center;">
                <p style="color: var(--color-secondary-tint); font-size: var(--font-size-caption); margin: 0;">
                    ¬© 2025 ShareTools. All rights reserved. | 
                    <a href="#" style="color: var(--color-secondary-tint);">Privacy Policy</a> | 
                    <a href="#" style="color: var(--color-secondary-tint);">Terms of Service</a>
                </p>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="{% static 'js/components.js' %}"></script>
    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/list_item.js' %}"></script>
    
    <!-- User state management styles and scripts -->
    <style>
        /* User state related styles */
        .user-state-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .user-state-actions .btn {
            transition: all 0.3s ease;
        }
        
        /* Login state transition animation */
        .user-state-actions.fade-out {
            opacity: 0;
            transform: translateX(10px);
        }
        
        .user-state-actions.fade-in {
            opacity: 1;
            transform: translateX(0);
        }
    </style>
    
    <!-- User state management script -->
    <script>
        // User login state management
        class UserAuthManager {
            constructor() {
                this.storageKey = 'sharetools_user_logged_in';
                this.userDataKey = 'sharetools_user_data';
                this.init();
            }

            // Initialize
            init() {
                this.updateNavigation();
                this.bindEvents();
                console.log('User authentication manager initialized');
            }

            // Check if user is logged in
            isLoggedIn() {
                // Check login status in localStorage
                const loginStatus = localStorage.getItem(this.storageKey);
                const userData = localStorage.getItem(this.userDataKey);
                
                // Check sessionStorage (for session-level login status)
                const sessionLogin = sessionStorage.getItem(this.storageKey);
                
                return (loginStatus === 'true' && userData) || sessionLogin === 'true';
            }

            // Set login status
            setLoginStatus(isLoggedIn, userData = null, rememberMe = false) {
                if (isLoggedIn) {
                    // Set login status
                    if (rememberMe) {
                        localStorage.setItem(this.storageKey, 'true');
                        if (userData) {
                            localStorage.setItem(this.userDataKey, JSON.stringify(userData));
                        }
                    } else {
                        // Keep login only during session
                        sessionStorage.setItem(this.storageKey, 'true');
                        if (userData) {
                            sessionStorage.setItem(this.userDataKey, JSON.stringify(userData));
                        }
                    }
                    console.log('User login status has been set');
                } else {
                    // Clear login status
                    localStorage.removeItem(this.storageKey);
                    localStorage.removeItem(this.userDataKey);
                    sessionStorage.removeItem(this.storageKey);
                    sessionStorage.removeItem(this.userDataKey);
                    console.log('User login status has been cleared');
                }
                
                this.updateNavigation();
            }

            // Get user data
            getUserData() {
                const localData = localStorage.getItem(this.userDataKey);
                const sessionData = sessionStorage.getItem(this.userDataKey);
                
                if (localData) {
                    try {
                        return JSON.parse(localData);
                    } catch (e) {
                        console.error('Failed to parse user data:', e);
                    }
                }
                
                if (sessionData) {
                    try {
                        return JSON.parse(sessionData);
                    } catch (e) {
                        console.error('Failed to parse session user data:', e);
                    }
                }
                
                return null;
            }

            // Update navigation display
            updateNavigation() {
                const guestActions = document.getElementById('guest-actions');
                const loggedInActions = document.getElementById('logged-in-actions');
                
                if (!guestActions || !loggedInActions) {
                    console.warn('Navigation elements not found');
                    return;
                }

                const isLoggedIn = this.isLoggedIn();
                
                if (isLoggedIn) {
                    // Show logged-in navigation state
                    this.showElement(loggedInActions);
                    this.hideElement(guestActions);
                    console.log('Showing logged-in navigation state');
                } else {
                    // Show logged-out navigation state
                    this.showElement(guestActions);
                    this.hideElement(loggedInActions);
                    console.log('Showing logged-out navigation state');
                }
            }

            // Show element (with animation)
            showElement(element) {
                element.style.display = 'flex';
                element.classList.remove('fade-out');
                element.classList.add('fade-in');
            }

            // Hide element (with animation)
            hideElement(element) {
                element.classList.remove('fade-in');
                element.classList.add('fade-out');
                setTimeout(() => {
                    element.style.display = 'none';
                }, 300);
            }

            // Bind events
            bindEvents() {
                // Listen for storage changes (cross-tab sync)
                window.addEventListener('storage', (e) => {
                    if (e.key === this.storageKey || e.key === this.userDataKey) {
                        console.log('Detected cross-tab login status change');
                        this.updateNavigation();
                    }
                });

                // Listen for custom login events
                window.addEventListener('userLogin', (e) => {
                    console.log('Received user login event:', e.detail);
                    this.setLoginStatus(true, e.detail.userData, e.detail.rememberMe);
                });

                // Listen for custom logout events
                window.addEventListener('userLogout', () => {
                    console.log('Received user logout event');
                    this.setLoginStatus(false);
                });
            }
        }

        // Initialize user authentication manager
        let userAuthManager;
        document.addEventListener('DOMContentLoaded', () => {
            userAuthManager = new UserAuthManager();
            window.userAuthManager = userAuthManager;
            
            // Wait for API configuration to load, then initialize
            initializeApp();
        });
        
        // Application initialization function
        async function initializeApp() {
            let attempts = 0;
            const maxAttempts = 10;
            
            const tryInitialize = () => {
                attempts++;
                
                if (checkAPIAvailability()) {
                    console.log('API configuration loaded, starting form initialization...');
                    initListItemForm();
                    return;
                }
                
                if (attempts < maxAttempts) {
                    console.log(`API configuration not ready, waiting... (${attempts}/${maxAttempts})`);
                    setTimeout(tryInitialize, 200);
                } else {
                    console.warn('API configuration load timeout, will use fallback method');
                    initListItemForm();
                }
            };
            
            tryInitialize();
        }
        
        // Initialize form handling
        function initListItemForm() {
            console.log('Starting form initialization...');
            
            const form = document.getElementById('list-item-form');
            if (!form) {
                console.error('Form element not found');
                return;
            }
            
            // Bind form submit event
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleItemSubmit(form);
            });
            
            // ÁªëÂÆöÂèëÂ∏ÉÊåâÈíÆ‰∫ã‰ª∂
            const publishBtn = form.querySelector('.publish-btn');
            if (publishBtn) {
                publishBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await handleItemSubmit(form);
                });
            }

            // ÂàùÂßãÂåñÊñá‰ª∂‰∏ä‰º†ÁõëÂê¨Âô®
            initFileUploadListeners();
            
            // Â∞ÜÂáΩÊï∞Ê≥®ÂÜåÂà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºå‰ª•‰æøÂú®Ê®°ÊÄÅÊ°Ü‰∏≠Ë∞ÉÁî®
            window.goToItemPage = goToItemPage;
            window.closeSuccessModal = closeSuccessModal;
            
            // ÂàùÂßãÂåñÂàÜÁ±ªÂèòÂåñÁõëÂê¨Âô®
            const categorySelect = form.querySelector('#category');
            if (categorySelect) {
                categorySelect.addEventListener('change', updatePriceSuggestions);
            }
            
            console.log('Ë°®ÂçïÂàùÂßãÂåñÂÆåÊàê');
        }
        
        // Êî∂ÈõÜË°®ÂçïÊï∞ÊçÆ
        async function collectFormData(form) {
            const categoryValue = form.querySelector('#category')?.value || '';
            
            // Ëé∑ÂèñÂàÜÁ±ªID
            let categoryId = null;
            if (categoryValue) {
                try {
                    if (typeof window.CategoriesAPI !== 'undefined') {
                        const categories = await window.CategoriesAPI.getCategories();
                        const category = categories.results?.find(cat => cat.name === categoryValue);
                        categoryId = category ? category.id : null;
                    } else {
                        console.warn('CategoriesAPIÊú™ÂÆö‰πâÔºå‰ΩøÁî®ÂàÜÁ±ªÂêçÁß∞‰Ωú‰∏∫ID');
                        // Â¶ÇÊûúAPI‰∏çÂèØÁî®ÔºåÂ∞ùËØï‰ΩøÁî®È¢ÑÂÆö‰πâÁöÑÂàÜÁ±ªÊò†Â∞Ñ
                        const categoryMap = {
                            'tools': 1,
                            'electronics': 2,
                            'garden': 3,
                            'sports': 4,
                            'automotive': 5,
                            'home': 6
                        };
                        categoryId = categoryMap[categoryValue] || 1;
                    }
                } catch (error) {
                    console.error('Ëé∑ÂèñÂàÜÁ±ªÂ§±Ë¥•:', error);
                    // ‰ΩøÁî®ÈªòËÆ§ÂàÜÁ±ªID
                    categoryId = 1;
                }
            }
            
            // Ëé∑ÂèñÈªòËÆ§‰ΩçÁΩÆIDÔºà‰∏¥Êó∂Ëß£ÂÜ≥ÊñπÊ°àÔºâ
            let locationId = 1; // ÈªòËÆ§‰ΩçÁΩÆID
            try {
                if (typeof window.LocationsAPI !== 'undefined') {
                    const locations = await window.LocationsAPI.getLocations();
                    if (locations.results && locations.results.length > 0) {
                        locationId = locations.results[0].id;
                    }
                } else {
                    console.warn('LocationsAPIÊú™ÂÆö‰πâÔºå‰ΩøÁî®ÈªòËÆ§‰ΩçÁΩÆID');
                    locationId = 1;
                }
            } catch (error) {
                console.error('Ëé∑Âèñ‰ΩçÁΩÆÂ§±Ë¥•:', error);
                locationId = 1; // Á°Æ‰øùÊúâÈªòËÆ§ÂÄº
            }
            
            // ÊûÑÂª∫Ë°®ÂçïÊï∞ÊçÆ - ‰øÆÂ§çÂ≠óÊÆµÂêçÂåπÈÖçÈóÆÈ¢ò
            const formData = {
                title: form.querySelector('#title')?.value?.trim() || '',
                description: form.querySelector('#description')?.value?.trim() || '',
                category_id: categoryId,
                location_id: locationId,
                item_value: form.querySelector('#item-value')?.value?.trim() || '',
                status: 'active',
                // ‰øÆÂ§ç‰ª∑Ê†ºÂ≠óÊÆµÂêçÂåπÈÖç
                price_1_day: form.querySelector('#price-1day')?.value?.trim() || '',
                price_3_days: form.querySelector('#price-3days')?.value?.trim() || '',
                price_7_days: form.querySelector('#price-7days')?.value?.trim() || ''
            };
            
            console.log('Êî∂ÈõÜÂà∞ÁöÑË°®ÂçïÊï∞ÊçÆ:', formData);
            return formData;
        }

        // Ê£ÄÊü•APIÂèØÁî®ÊÄß
        function checkAPIAvailability() {
            const apis = ['ItemsAPI', 'ItemImagesAPI', 'ItemPricesAPI', 'CategoriesAPI', 'LocationsAPI'];
            const missing = apis.filter(api => typeof window[api] === 'undefined');
            
            if (missing.length > 0) {
                console.warn('‰ª•‰∏ãAPIÊú™Ê≠£Á°ÆÂä†ËΩΩ:', missing);
                console.log('Â∞Ü‰ΩøÁî®Â§áÁî®ÊñπÊ≥ïÂ§ÑÁêÜËØ∑Ê±Ç');
                return false;
            } else {
                console.log('ÊâÄÊúâAPIÂ∑≤Ê≠£Á°ÆÂä†ËΩΩ');
                return true;
            }
        }
        
        // Áâ©ÂìÅÂèëÂ∏ÉË°®ÂçïÂ§ÑÁêÜ
        function initListItemForm() {
            const form = document.getElementById('list-item-form');
            if (!form) {
                console.error('Ë°®ÂçïÂÖÉÁ¥†Êú™ÊâæÂà∞');
                return;
            }
            
            // Ë°®ÂçïÊèê‰∫§Â§ÑÁêÜ
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleItemSubmit(form);
            });
            
            // ‰ª∑Ê†ºÂª∫ËÆÆÂäüËÉΩ
            const categorySelect = document.getElementById('category');
            if (categorySelect) {
                categorySelect.addEventListener('change', updatePriceSuggestions);
            }
        }
        
        // Â§ÑÁêÜÁâ©ÂìÅÊèê‰∫§
        async function handleItemSubmit(form) {
            const submitBtn = form.querySelector('.publish-btn');
            const originalText = submitBtn.textContent;
            
            let itemId = null;
            let response = null;
            let uploadedImages = [];
            let createdPrices = [];
            let hasErrors = false;
            let errorMessages = [];
            
            try {
                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                submitBtn.disabled = true;
                submitBtn.textContent = 'ÂèëÂ∏É‰∏≠...';
                
                // Êî∂ÈõÜË°®ÂçïÊï∞ÊçÆ
                const formData = await collectFormData(form);
                console.log('üìã Ë°®ÂçïÊï∞ÊçÆÊî∂ÈõÜÂÆåÊàê:', formData);
                
                // È™åËØÅË°®ÂçïÊï∞ÊçÆÔºàÂºÇÊ≠•Ôºâ
                const isValid = await validateFormData(formData);
                if (!isValid) {
                    console.log('‚ùå Ë°®ÂçïÈ™åËØÅÂ§±Ë¥•');
                    // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                console.log('‚úÖ Ë°®ÂçïÈ™åËØÅÈÄöËøá');
                
                // Á¨¨‰∏ÄÊ≠•ÔºöÂàõÂª∫Áâ©ÂìÅ
                submitBtn.textContent = 'ÂàõÂª∫ÂïÜÂìÅ...';
                console.log('üõ†Ô∏è ÂºÄÂßãÂàõÂª∫Áâ©ÂìÅ...');
                
                response = await window.ItemsAPI.createItem(formData);
                
                if (!response || !response.id) {
                    throw new Error('ÂàõÂª∫Áâ©ÂìÅÂ§±Ë¥•ÔºöAPIËøîÂõûÊó†ÊïàÂìçÂ∫î');
                }
                
                itemId = response.id;
                console.log('‚úÖ ÂïÜÂìÅÂàõÂª∫ÊàêÂäüÔºåID:', itemId);
                
                // Á¨¨‰∫åÊ≠•Ôºö‰∏ä‰º†ÂõæÁâá
                submitBtn.textContent = '‰∏ä‰º†ÂõæÁâá...';
                console.log('üì∏ ÂºÄÂßã‰∏ä‰º†ÂõæÁâá...');
                
                try {
                    uploadedImages = await uploadItemImages(itemId, form);
                    console.log('‚úÖ ÂõæÁâá‰∏ä‰º†ÂÆåÊàêÔºå‰∏ä‰º†Êï∞Èáè:', uploadedImages.length);
                } catch (imageError) {
                    console.error('‚ö†Ô∏è ÂõæÁâá‰∏ä‰º†ËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ:', imageError);
                    errorMessages.push('ÈÉ®ÂàÜÂõæÁâá‰∏ä‰º†Â§±Ë¥•');
                    hasErrors = true;
                }
                
                // Á¨¨‰∏âÊ≠•ÔºöÂàõÂª∫‰ª∑Ê†ºËÆ∞ÂΩï
                submitBtn.textContent = 'ËÆæÁΩÆ‰ª∑Ê†º...';
                console.log('üí∞ ÂºÄÂßãÂàõÂª∫‰ª∑Ê†º...');
                
                try {
                    createdPrices = await createItemPrices(itemId, formData);
                    console.log('‚úÖ ‰ª∑Ê†ºÂàõÂª∫ÂÆåÊàêÔºå‰ª∑Ê†ºÊï∞Èáè:', createdPrices.length);
                } catch (priceError) {
                    console.error('‚ö†Ô∏è ‰ª∑Ê†ºÂàõÂª∫ËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ:', priceError);
                    errorMessages.push('‰ª∑Ê†ºËÆæÁΩÆÂ§±Ë¥•Ôºö' + priceError.message);
                    hasErrors = true;
                }
                
                // ÂèëÂ∏ÉÊàêÂäüÔºàÂç≥‰ΩøÊúâÈÉ®ÂàÜÈîôËØØÔºâ
                submitBtn.textContent = 'ÂèëÂ∏ÉÂÆåÊàêÔºÅ';
                console.log('üéâ Áâ©ÂìÅÂèëÂ∏ÉÊµÅÁ®ãÂÆåÊàêÔºÅ');
                console.log(`- Áâ©ÂìÅID: ${itemId}`);
                console.log(`- Ê†áÈ¢ò: ${formData.title}`);
                console.log(`- ÂõæÁâáÊï∞Èáè: ${uploadedImages.length}`);
                console.log(`- ‰ª∑Ê†ºÊ°£Ê¨°: ${createdPrices.length}`);
                console.log(`- ÊòØÂê¶ÊúâÈîôËØØ: ${hasErrors}`);
                
                // ÊûÑÂª∫ÊàêÂäüÊ∂àÊÅØ
                const successMessage = buildSuccessMessage(response, uploadedImages, createdPrices, hasErrors, errorMessages);
                showEnhancedSuccessMessage(successMessage, itemId);
                
                // ÈáçÁΩÆË°®Âçï
                form.reset();
                resetImageSlots();
                
                // ‰∏çÈúÄË¶ÅÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅÔºåÂõ†‰∏∫‰ºöË∑≥ËΩ¨È°µÈù¢
                return;
                
            } catch (error) {
                console.error('‚ùå Item publishing failed:', error);
                
                // Â¶ÇÊûúÁâ©ÂìÅÂ∑≤ÂàõÂª∫‰ΩÜÂêéÁª≠Ê≠•È™§Â§±Ë¥•ÔºåÊèê‰æõÊõ¥ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
                if (itemId) {
                    const detailedError = `Item created successfully but there was a problem during publishing: ${error.message}. Item ID: ${itemId}, you can manually edit and complete it later.`;
                    showErrorMessage(detailedError);
                    
                    // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    
                    // Êèê‰æõË∑≥ËΩ¨ÈÄâÈ°π
                    setTimeout(() => {
                        if (confirm('Item has been created but may be incomplete. Would you like to view the item details page?')) {
                            window.location.href = `/product/${itemId}/`;
                        }
                    }, 3000);
                } else {
                    showErrorMessage('Publishing failed: ' + (error.message || 'Unknown error'));
                    // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }
        }
        

        
        // ‰∏ä‰º†Áâ©ÂìÅÂõæÁâá - ‰ΩøÁî®ÊâπÈáè‰∏ä‰º†API
        async function uploadItemImages(itemId, form) {
            const uploadedImages = [];
            const selectedImages = getSelectedImages();
            
            if (selectedImages.length === 0) {
                console.log('No images selected, skipping upload');
                return uploadedImages;
            }
            
            console.log(`Starting batch upload of ${selectedImages.length} image(s)`);
            
            try {
                // ÊûÑÂª∫ÊâπÈáè‰∏ä‰º†ÁöÑFormData
                const formData = new FormData();
                formData.append('item_id', itemId);
                
                selectedImages.forEach((imageInfo, index) => {
                    formData.append(`image_${index + 1}`, imageInfo.file);
                    
                    // ÊòæÁ§∫‰∏ä‰º†‰∏≠Áä∂ÊÄÅ
                    updateImageUploadStatus(imageInfo.index, 'uploading');
                });
                
                // ÂèëÈÄÅÊâπÈáè‰∏ä‰º†ËØ∑Ê±Ç
                const response = await fetch('/api/item-images/bulk_upload/', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCSRFToken()
                    },
                    credentials: 'include',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Batch upload successful:', result);
                    
                    if (result.success && result.uploaded_images) {
                        // Êõ¥Êñ∞ÊâÄÊúâ‰∏ä‰º†ÊàêÂäüÁöÑÂõæÁâáÁä∂ÊÄÅ
                        selectedImages.forEach((imageInfo, index) => {
                            if (index < result.uploaded_images.length) {
                                updateImageUploadStatus(imageInfo.index, 'success');
                            }
                        });
                        
                        uploadedImages.push(...result.uploaded_images);
                    }
                    
                    // ËÆ∞ÂΩï‰ªª‰ΩïÈîôËØØ
                    if (result.errors && result.errors.length > 0) {
                        console.warn('Some images had errors:', result.errors);
                    }
                } else {
                    // ÊâπÈáè‰∏ä‰º†Â§±Ë¥•ÔºåÂ∞ùËØïÈÄê‰∏™‰∏ä‰º†
                    console.warn('Batch upload failed, falling back to individual uploads');
                    return await uploadImagesIndividually(itemId, form, selectedImages);
                }
                
            } catch (error) {
                console.error('Batch upload error:', error);
                // ÊâπÈáè‰∏ä‰º†Â§±Ë¥•ÔºåÂ∞ùËØïÈÄê‰∏™‰∏ä‰º†
                return await uploadImagesIndividually(itemId, form, selectedImages);
            }
            
            console.log(`Image upload complete, successfully uploaded ${uploadedImages.length}/${selectedImages.length} image(s)`);
            return uploadedImages;
        }
        
        // Â§áÁî®ÁöÑÈÄê‰∏™‰∏ä‰º†ÂáΩÊï∞
        async function uploadImagesIndividually(itemId, form, selectedImages) {
            const uploadedImages = [];
            
            console.log('Using individual upload method...');
            
            for (const imageInfo of selectedImages) {
                try {
                    console.log(`Uploading image ${imageInfo.index}: ${imageInfo.file.name}`);
                    
                    // ÊòæÁ§∫‰∏ä‰º†‰∏≠Áä∂ÊÄÅ
                    updateImageUploadStatus(imageInfo.index, 'uploading');
                    
                    const formData = new FormData();
                    formData.append('item', itemId);
                    formData.append('image', imageInfo.file);
                    formData.append('is_primary', imageInfo.index === 1); // Á¨¨‰∏ÄÂº†ÂõæÁâá‰∏∫‰∏ªÂõæ
                    formData.append('alt_text', form.querySelector('#title')?.value?.trim() || 'Product image');
                    formData.append('order', imageInfo.index);
                    
                    const response = await fetch('/api/item-images/', {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCSRFToken()
                        },
                        credentials: 'include',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        uploadedImages.push(result);
                        console.log(`‚úÖ Image ${imageInfo.index} uploaded successfully:`, result);
                        
                        // Êõ¥Êñ∞UIÊòæÁ§∫‰∏ä‰º†ÊàêÂäü
                        updateImageUploadStatus(imageInfo.index, 'success');
                    } else {
                        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                        console.error(`‚ùå Image ${imageInfo.index} upload failed:`, response.status, errorData);
                        
                        // Êõ¥Êñ∞UIÊòæÁ§∫‰∏ä‰º†Â§±Ë¥•
                        updateImageUploadStatus(imageInfo.index, 'error');
                        
                        // Â¶ÇÊûúÊòØ‰∏ªÂõæ‰∏ä‰º†Â§±Ë¥•ÔºåÊäõÂá∫ÈîôËØØ
                        if (imageInfo.index === 1) {
                            throw new Error(`Primary image upload failed: ${errorData.error || 'Unknown error'}`);
                        }
                    }
                } catch (error) {
                    console.error(`Image ${imageInfo.index} upload exception:`, error);
                    updateImageUploadStatus(imageInfo.index, 'error');
                    
                    // Â¶ÇÊûúÊòØ‰∏ªÂõæ‰∏ä‰º†Â§±Ë¥•ÔºåÊäõÂá∫ÈîôËØØ
                    if (imageInfo.index === 1) {
                        throw error;
                    }
                }
            }
            
            return uploadedImages;
        }
        
        // Êõ¥Êñ∞ÂõæÁâá‰∏ä‰º†Áä∂ÊÄÅÊòæÁ§∫
        function updateImageUploadStatus(imageIndex, status) {
            const fileInput = document.getElementById(`file-input-${imageIndex}`);
            const slot = fileInput?.parentNode;
            
            if (slot) {
                const statusIcon = slot.querySelector('.upload-status') || document.createElement('div');
                statusIcon.className = 'upload-status';
                statusIcon.style.cssText = `
                    position: absolute;
                    bottom: 5px;
                    left: 5px;
                    padding: 2px 6px;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: bold;
                    z-index: 11;
                `;
                
                if (status === 'success') {
                    statusIcon.innerHTML = '‚úì Uploaded';
                    statusIcon.style.background = 'rgba(0, 128, 0, 0.9)';
                    statusIcon.style.color = 'white';
                } else if (status === 'error') {
                    statusIcon.innerHTML = '‚úó Failed';
                    statusIcon.style.background = 'rgba(255, 0, 0, 0.9)';
                    statusIcon.style.color = 'white';
                } else if (status === 'uploading') {
                    statusIcon.innerHTML = '‚è≥ Uploading';
                    statusIcon.style.background = 'rgba(0, 123, 255, 0.9)';
                    statusIcon.style.color = 'white';
                }
                
                const previewContainer = slot.querySelector('div');
                if (previewContainer && !previewContainer.contains(statusIcon)) {
                    previewContainer.appendChild(statusIcon);
                }
            }
        }
        
        // ÊâãÂä®‰∏ä‰º†ÂõæÁâáÁöÑÂ§áÁî®ÊñπÊ≥ï
        async function uploadImagesManually(itemId, form) {
            const uploadedImages = [];
            const API_BASE = 'http://127.0.0.1:8000/api';
            
            // Ëé∑ÂèñÊâÄÊúâÊñá‰ª∂ËæìÂÖ•
            for (let i = 1; i <= 8; i++) {
                const fileInput = form.querySelector(`#file-input-${i}`);
                if (fileInput && fileInput.files && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    const isPrimary = i === 1; // Á¨¨‰∏ÄÂº†ÂõæÁâá‰Ωú‰∏∫‰∏ªÂõæ
                    const altText = form.querySelector('#title')?.value?.trim() || 'ÂïÜÂìÅÂõæÁâá';
                    const order = i - 1;
                    
                    try {
                        console.log(`ÊâãÂä®‰∏ä‰º†Á¨¨${i}Âº†ÂõæÁâá:`, file.name);
                        
                        const formData = new FormData();
                        formData.append('item', itemId);
                        formData.append('image', file);
                        formData.append('is_primary', isPrimary);
                        formData.append('alt_text', altText);
                        formData.append('order', order);
                        
                        const response = await fetch(`${API_BASE}/item-images/`, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRFToken': getCSRFToken()
                            },
                            credentials: 'include',
                            body: formData
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            uploadedImages.push(result);
                            console.log(`ÊâãÂä®‰∏ä‰º†Á¨¨${i}Âº†ÂõæÁâáÊàêÂäü:`, result);
                        } else {
                            const errorText = await response.text();
                            console.error(`ÂõæÁâá${i}‰∏ä‰º†Â§±Ë¥•:`, response.status, errorText);
                        }
                    } catch (error) {
                        console.error(`ÂõæÁâá${i}‰∏ä‰º†ÈîôËØØ:`, error);
                    }
                }
            }
            
            return uploadedImages;
        }
        
        // ÂàõÂª∫Áâ©ÂìÅ‰ª∑Ê†º
        async function createItemPrices(itemId, formData) {
            const createdPrices = [];
            
            // Ê£ÄÊü•APIÊòØÂê¶ÂèØÁî®ÔºåÂ¶ÇÊûú‰∏çÂèØÁî®Âàô‰ΩøÁî®ÊâãÂä®ÊñπÊ≥ï
            if (typeof window.ItemPricesAPI === 'undefined') {
                console.warn('ItemPricesAPI Êú™ÂÆö‰πâÔºå‰ΩøÁî®ÊâãÂä®ÂàõÂª∫‰ª∑Ê†ºÊñπÊ≥ï');
                return await createPricesManually(itemId, formData);
            }
            
            // ÂàõÂª∫1Â§©‰ª∑Ê†ºÔºàÂøÖÈ°ªÔºâ
            if (formData.price_1_day && parseFloat(formData.price_1_day) > 0) {
                try {
                    const price1Day = await window.ItemPricesAPI.createPrice(itemId, 1, formData.price_1_day);
                    createdPrices.push(price1Day);
                    console.log('‚úÖ 1Â§©‰ª∑Ê†ºÂàõÂª∫ÊàêÂäü:', price1Day);
                } catch (error) {
                    console.error('‚ùå 1Â§©‰ª∑Ê†ºÂàõÂª∫Â§±Ë¥•:', error);
                    // 1Â§©‰ª∑Ê†ºÂàõÂª∫Â§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ΩÜ‰∏çÈòªÊ≠¢ÊµÅÁ®ã
                    const errorMsg = 'ÂàõÂª∫1Â§©‰ª∑Ê†ºÂ§±Ë¥•Ôºö' + (error.message || 'Êú™Áü•ÈîôËØØ');
                    console.warn('‚ö†Ô∏è ' + errorMsg);
                    // ‰∏çÊäõÂá∫ÂºÇÂ∏∏ÔºåËÆ©Ë∞ÉÁî®ËÄÖÂ§ÑÁêÜ
                }
            }
            
            // ÂàõÂª∫3Â§©‰ª∑Ê†ºÔºàÂèØÈÄâÔºâ
            if (formData.price_3_days && parseFloat(formData.price_3_days) > 0) {
                try {
                    const price3Days = await window.ItemPricesAPI.createPrice(itemId, 3, formData.price_3_days);
                    createdPrices.push(price3Days);
                    console.log('3Â§©‰ª∑Ê†ºÂàõÂª∫ÊàêÂäü:', price3Days);
                } catch (error) {
                    console.error('3Â§©‰ª∑Ê†ºÂàõÂª∫Â§±Ë¥•:', error);
                    // 3Â§©‰ª∑Ê†ºÂàõÂª∫Â§±Ë¥•‰∏çÈòªÊ≠¢ÊµÅÁ®ã
                }
            }
            
            // ÂàõÂª∫7Â§©‰ª∑Ê†ºÔºàÂèØÈÄâÔºâ
            if (formData.price_7_days && parseFloat(formData.price_7_days) > 0) {
                try {
                    const price7Days = await window.ItemPricesAPI.createPrice(itemId, 7, formData.price_7_days);
                    createdPrices.push(price7Days);
                    console.log('7Â§©‰ª∑Ê†ºÂàõÂª∫ÊàêÂäü:', price7Days);
                } catch (error) {
                    console.error('7Â§©‰ª∑Ê†ºÂàõÂª∫Â§±Ë¥•:', error);
                    // 7Â§©‰ª∑Ê†ºÂàõÂª∫Â§±Ë¥•‰∏çÈòªÊ≠¢ÊµÅÁ®ã
                }
            }
            
            return createdPrices;
        }
        
        // ÊâãÂä®ÂàõÂª∫‰ª∑Ê†ºÁöÑÂ§áÁî®ÊñπÊ≥ï
        async function createPricesManually(itemId, formData) {
            const createdPrices = [];
            const API_BASE = 'http://127.0.0.1:8000/api';
            
            const pricesData = [
                { duration: 1, price: formData.price_1_day },
                { duration: 3, price: formData.price_3_days },
                { duration: 7, price: formData.price_7_days }
            ];
            
            for (const priceInfo of pricesData) {
                if (priceInfo.price && parseFloat(priceInfo.price) > 0) {
                    try {
                        const response = await fetch(`${API_BASE}/item-prices/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                item: itemId,
                                duration_days: priceInfo.duration,
                                price: priceInfo.price,
                                is_active: true
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            createdPrices.push(result);
                            console.log(`${priceInfo.duration}Â§©‰ª∑Ê†ºÂàõÂª∫ÊàêÂäü:`, result);
                        } else {
                            const errorText = await response.text();
                            console.error(`‚ùå ${priceInfo.duration}Â§©‰ª∑Ê†ºÂàõÂª∫Â§±Ë¥•:`, response.status, errorText);
                            if (priceInfo.duration === 1) {
                                console.warn('‚ö†Ô∏è 1Â§©‰ª∑Ê†ºÂàõÂª∫Â§±Ë¥•Ôºå‰ΩÜ‰∏çÈòªÊ≠¢ÂèëÂ∏ÉÊµÅÁ®ã');
                            }
                        }
                    } catch (error) {
                        console.error(`‚ùå ${priceInfo.duration}Â§©‰ª∑Ê†ºÂàõÂª∫ÈîôËØØ:`, error);
                        if (priceInfo.duration === 1) {
                            console.warn('‚ö†Ô∏è 1Â§©‰ª∑Ê†ºÂàõÂª∫Â§±Ë¥•Ôºå‰ΩÜ‰∏çÈòªÊ≠¢ÂèëÂ∏ÉÊµÅÁ®ã');
                        }
                    }
                }
            }
            
            return createdPrices;
        }
        
        // ÈáçÁΩÆÂõæÁâá‰∏ä‰º†Âå∫Âüü
        function resetImageSlots() {
            for (let i = 1; i <= 8; i++) {
                const fileInput = document.getElementById(`file-input-${i}`);
                const slot = fileInput?.parentNode;
                
                if (fileInput) {
                    fileInput.value = '';
                }
                
                if (slot) {
                    slot.style.backgroundImage = '';
                    slot.innerHTML = `
                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 15V3" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <input type="file" id="file-input-${i}" accept="image/*" style="display: none;">
                    `;
                }
            }
            
            // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®
            initFileUploadListeners();
        }
        
        // Ë°®ÂçïÈ™åËØÅÂáΩÊï∞ - ‰ΩøÁî®ÂÆ¢Êà∑Á´ØÈ™åËØÅÔºàÈÅøÂÖç‰∏çÂøÖË¶ÅÁöÑAPIË∞ÉÁî®Ôºâ
        function validateFormData(data) {
            console.log('ÂºÄÂßãÈ™åËØÅË°®ÂçïÊï∞ÊçÆ...', data);
            return validateFormDataLocally(data);
        }
        
        // ÂÆ¢Êà∑Á´ØÈ™åËØÅÂáΩÊï∞
        function validateFormDataLocally(data) {
            const errors = [];
            
            // Âü∫Êú¨‰ø°ÊÅØÈ™åËØÅ
            if (!data.title || data.title.length < 2) {
                errors.push('Please enter a title with at least 2 characters');
            }
            
            if (!data.description || data.description.length < 10) {
                errors.push('Please enter a description with at least 10 characters');
            }
            
            // Á±ªÂà´È™åËØÅ - Ê£ÄÊü•ÂéüÂßãÈÄâÊã©ÂÄºËÄå‰∏çÊòØAPIÊò†Â∞Ñ
            const categorySelect = document.getElementById('category');
            if (!categorySelect || !categorySelect.value) {
                errors.push('Please select a category');
            }
            
            // ÂõæÁâáÈ™åËØÅ - ‰ΩøÁî®getSelectedImagesÂáΩÊï∞ËøõË°åÂèØÈù†Ê£ÄÊµã
            let hasImages = false;
            let imageCount = 0;
            
            try {
                // ‰ΩøÁî®Áé∞ÊúâÁöÑgetSelectedImagesÂáΩÊï∞
                const selectedImages = getSelectedImages();
                hasImages = selectedImages.length > 0;
                imageCount = selectedImages.length;
                
                console.log(`üîç Image validation using getSelectedImages: hasImages=${hasImages}, imageCount=${imageCount}`);
                
                if (hasImages) {
                    selectedImages.forEach((img, index) => {
                        console.log(`‚úÖ Found image ${index + 1}: ${img.file.name}, size: ${(img.file.size / 1024 / 1024).toFixed(2)}MB, slot: ${img.index}`);
                    });
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÂõæÁâáÔºåÊ£ÄÊü•ÊØè‰∏™ËæìÂÖ•ÂÖÉÁ¥†ÁöÑÁä∂ÊÄÅ
                    console.log('üîç No images found, checking individual file inputs:');
                    for (let i = 1; i <= 8; i++) {
                        const fileInput = document.getElementById(`file-input-${i}`);
                        console.log(`- Input ${i}: exists=${!!fileInput}, files=${fileInput?.files?.length || 0}, value="${fileInput?.value || 'empty'}"`);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error in image validation using getSelectedImages:', error);
                
                // Â§áÁî®È™åËØÅÊñπÊ≥ïÔºöÊ£ÄÊü•DOMÂÖÉÁ¥†
                for (let i = 1; i <= 8; i++) {
                    const fileInput = document.getElementById(`file-input-${i}`);
                    if (fileInput && fileInput.files && fileInput.files.length > 0) {
                        hasImages = true;
                        imageCount++;
                        console.log(`Backup method: Found image in slot ${i}:`, fileInput.files[0].name);
                    }
                }
                
                // Á¨¨‰∫åÂ§áÁî®ÊñπÊ≥ïÔºöÊ£ÄÊü•È¢ÑËßàÂõæÁâá
                if (!hasImages) {
                    const uploadSlots = document.querySelectorAll('.upload-slot');
                    uploadSlots.forEach((slot, index) => {
                        const preview = slot.querySelector('.img-preview');
                        if (preview && preview.src && !preview.src.includes('data:') && preview.style.display !== 'none') {
                            hasImages = true;
                            imageCount++;
                            console.log(`Backup method: Found preview image in slot ${index + 1}`);
                        }
                    });
                }
            }
            
            if (!hasImages) {
                errors.push('Please upload at least one image');
            }
            
            // ‰ª∑Ê†ºÈ™åËØÅ
            const price1Day = parseFloat(data.price_1_day);
            if (!data.price_1_day || isNaN(price1Day) || price1Day <= 0) {
                errors.push('Please enter a valid 1-day rental price');
            }
            
            const itemValue = parseFloat(data.item_value);
            if (!data.item_value || isNaN(itemValue) || itemValue <= 0) {
                errors.push('Please enter a valid item value');
            }
            
            // ‰ΩçÁΩÆÈ™åËØÅ
            const locationSelect = document.getElementById('location');
            if (!locationSelect || !locationSelect.value) {
                errors.push('Please select a location');
            }
            
            if (errors.length > 0) {
                showErrorMessage('Please complete the following information:\n' + errors.join('\n'));
                return false;
            }
            
            console.log('‚úÖ Client-side validation passed');
            return true;
        }
        
        // Êõ¥Êñ∞‰ª∑Ê†ºÂª∫ËÆÆ - ‰ΩøÁî®ÊúçÂä°Âô®Á´ØAPI
        async function updatePriceSuggestions() {
            const category = document.getElementById('category')?.value;
            const categoryNameSpan = document.getElementById('category-name');
            const selectedCategorySpan = document.getElementById('selected-category');
            
            if (categoryNameSpan) {
                categoryNameSpan.textContent = category || 'selected category';
            }
            
            if (selectedCategorySpan) {
                selectedCategorySpan.textContent = category || 'selected category';
            }
            
            try {
                // ‰ªéÊúçÂä°Âô®Ëé∑Âèñ‰ª∑Ê†ºÂª∫ËÆÆ
                const response = await fetch(`/api/suggestions/prices/?category=${category || ''}`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const suggestions = result.suggestions;
                    
                    // Êõ¥Êñ∞È°µÈù¢ÊòæÁ§∫
                    document.getElementById('suggest-1day').textContent = suggestions['1'];
                    document.getElementById('suggest-3days').textContent = suggestions['3'];
                    document.getElementById('suggest-7days').textContent = suggestions['7'];
                    
                    console.log('Price suggestions updated successfully:', suggestions);
                } else {
                    console.warn('Failed to get price suggestions, using default values');
                    useDefaultSuggestions(category);
                }
            } catch (error) {
                console.error('Error getting price suggestions:', error);
                useDefaultSuggestions(category);
            }
        }
        
        // Â§áÁî®ÁöÑÊú¨Âú∞‰ª∑Ê†ºÂª∫ËÆÆ
        function useDefaultSuggestions(category) {
            const suggestions = {
                'tools': { day1: '15.00', day3: '40.00', day7: '80.00' },
                'electronics': { day1: '25.00', day3: '65.00', day7: '140.00' },
                'garden': { day1: '20.00', day3: '50.00', day7: '100.00' },
                'sports': { day1: '18.00', day3: '45.00', day7: '90.00' },
                'automotive': { day1: '30.00', day3: '80.00', day7: '180.00' },
                'home': { day1: '12.00', day3: '30.00', day7: '65.00' }
            };
            
            const categoryData = suggestions[category] || { day1: '15.00', day3: '40.00', day7: '80.00' };
            
            document.getElementById('suggest-1day').textContent = categoryData.day1;
            document.getElementById('suggest-3days').textContent = categoryData.day3;
            document.getElementById('suggest-7days').textContent = categoryData.day7;
        }
        
        // ‰ΩøÁî®‰ª∑Ê†ºÂª∫ËÆÆ - ‰ªéÈ°µÈù¢‰∏äÂ∑≤ÊòæÁ§∫ÁöÑÂª∫ËÆÆ‰∏≠Ëé∑Âèñ
        function usePriceSuggestions() {
            const suggest1Day = document.getElementById('suggest-1day').textContent;
            const suggest3Days = document.getElementById('suggest-3days').textContent;
            const suggest7Days = document.getElementById('suggest-7days').textContent;
            
            document.getElementById('price-1day').value = suggest1Day;
            document.getElementById('price-3days').value = suggest3Days;
            document.getElementById('price-7days').value = suggest7Days;
            
            console.log('Price suggestions applied:', { suggest1Day, suggest3Days, suggest7Days });
        }
        
        // ÊûÑÂª∫ÊàêÂäüÊ∂àÊÅØ
        function buildSuccessMessage(itemResponse, uploadedImages, createdPrices, hasErrors = false, errorMessages = []) {
            const itemTitle = itemResponse.title || 'Your item';
            const imageCount = uploadedImages.length;
            const priceCount = createdPrices.length;
            
            let message = `üéâ "${itemTitle}" published successfully!\n\n`;
            
            // Ê∑ªÂä†ËØ¶ÁªÜ‰ø°ÊÅØ
            if (imageCount > 0) {
                message += `üì∏ Successfully uploaded ${imageCount} image(s)\n`;
            } else {
                message += `üì∏ No images uploaded (you can add them later)\n`;
            }
            
            if (priceCount > 0) {
                message += `üí∞ Set ${priceCount} price level(s)\n`;
            } else {
                message += `üí∞ No prices set (please complete later)\n`;
            }
            
            // Â¶ÇÊûúÊúâÈîôËØØÔºåÊ∑ªÂä†Ë≠¶Âëä‰ø°ÊÅØ
            if (hasErrors && errorMessages.length > 0) {
                message += `\n‚ö†Ô∏è Notes:\n`;
                errorMessages.forEach(error => {
                    message += `‚Ä¢ ${error}\n`;
                });
                message += `\nYou can complete this information later on the item details page.`;
            }
            
            message += `\n‚ú® Your item is now visible to other users!`;
            
            return message;
        }
        
        // ÊòæÁ§∫Â¢ûÂº∫ÁöÑÊàêÂäüÊ∂àÊÅØ
        function showEnhancedSuccessMessage(message, itemId) {
            // ÂàõÂª∫Ê®°ÊÄÅÊ°ÜËÉåÊôØ
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            // ÂàõÂª∫ÊàêÂäüÂØπËØùÊ°Ü
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 30px;
                max-width: 500px;
                width: 90%;
                text-align: center;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: slideInUp 0.3s ease-out;
            `;
            
            // Ê∑ªÂä†CSSÂä®Áîª
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInUp {
                    from {
                        opacity: 0;
                        transform: translateY(30px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
                
                .success-btn {
                    background: #28a745;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 6px;
                    font-size: 16px;
                    font-weight: 500;
                    cursor: pointer;
                    margin: 0 8px;
                    transition: background 0.2s;
                }
                
                .success-btn:hover {
                    background: #218838;
                }
                
                .secondary-btn {
                    background: #6c757d;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 6px;
                    font-size: 16px;
                    font-weight: 500;
                    cursor: pointer;
                    margin: 0 8px;
                    transition: background 0.2s;
                }
                
                .secondary-btn:hover {
                    background: #5a6268;
                }
            `;
            document.head.appendChild(style);
            
            modal.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 20px;">üéâ</div>
                <h2 style="color: #28a745; margin-bottom: 20px; font-size: 24px;">Published Successfully!</h2>
                <p style="color: #666; line-height: 1.6; white-space: pre-line; margin-bottom: 30px;">${message}</p>
                <div style="margin-bottom: 20px;">
                    <button class="success-btn" onclick="goToItemPage('${itemId}')">View My Item</button>
                    <button class="secondary-btn" onclick="closeSuccessModal()">Continue Publishing</button>
                </div>
                <div id="countdown" style="color: #999; font-size: 14px;">Redirecting to item page in 3 seconds...</div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Â≠òÂÇ®ÂºïÁî®‰ª•‰æøÂêéÁª≠Êìç‰Ωú
            window.successModal = overlay;
            
            // ÂºÄÂßãÂÄíËÆ°Êó∂
            startCountdown(itemId);
        }
        
        // ÂºÄÂßãÂÄíËÆ°Êó∂
        function startCountdown(itemId) {
            let countdown = 3;
            const countdownElement = document.getElementById('countdown');
            
            const timer = setInterval(() => {
                countdown--;
                if (countdownElement) {
                    if (countdown > 0) {
                        countdownElement.textContent = `Redirecting to item page in ${countdown} seconds...`;
                    } else {
                        countdownElement.textContent = 'Redirecting...';
                    }
                }
                
                if (countdown <= 0) {
                    clearInterval(timer);
                    goToItemPage(itemId);
                }
            }, 1000);
            
            // Â≠òÂÇ®ÂÆöÊó∂Âô®ÂºïÁî®
            window.countdownTimer = timer;
        }
        
        // Ë∑≥ËΩ¨Âà∞Áâ©ÂìÅÈ°µÈù¢
        function goToItemPage(itemId) {
            if (window.countdownTimer) {
                clearInterval(window.countdownTimer);
            }
            closeSuccessModal();
            
            // ÊòæÁ§∫Ë∑≥ËΩ¨ÊèêÁ§∫
            showLoadingMessage('Redirecting to item page...');
            
            setTimeout(() => {
                window.location.href = '/browse-things/';
            }, 500);
        }
        
        // ÂÖ≥Èó≠ÊàêÂäüÊ®°ÊÄÅÊ°Ü
        function closeSuccessModal() {
            if (window.countdownTimer) {
                clearInterval(window.countdownTimer);
            }
            
            if (window.successModal) {
                window.successModal.remove();
                window.successModal = null;
            }
        }
        
        // ÊòæÁ§∫Âä†ËΩΩÊ∂àÊÅØ
        function showLoadingMessage(message) {
            const loadingDiv = document.createElement('div');
            loadingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 20px 30px;
                border-radius: 8px;
                z-index: 10001;
                font-size: 16px;
                text-align: center;
            `;
            loadingDiv.textContent = message;
            document.body.appendChild(loadingDiv);
            
            // 2ÁßíÂêéÁßªÈô§
            setTimeout(() => {
                loadingDiv.remove();
            }, 2000);
        }
        
        // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØÔºàÁÆÄÂçïÁâàÊú¨Ôºå‰øùÊåÅÂêëÂêéÂÖºÂÆπÔºâ
        function showSuccessMessage(message) {
            // ÂàõÂª∫Ê∂àÊÅØÂÖÉÁ¥†
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success-message';
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--color-success, #28a745);
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                font-weight: 500;
            `;
            
            document.body.appendChild(messageDiv);
            
            // 3ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
        
        // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
        function showErrorMessage(message) {
            // ÂàõÂª∫Ê∂àÊÅØÂÖÉÁ¥†
            const messageDiv = document.createElement('div');
            messageDiv.className = 'error-message';
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--color-danger, #dc3545);
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                font-weight: 500;
                white-space: pre-line;
            `;
            
            document.body.appendChild(messageDiv);
            
            // 5ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
    </script>
    
    <script>
        // Á±ªÂà´ÈÄâÊã©ÂäüËÉΩ
        document.getElementById('category').addEventListener('change', function() {
            const selectedCategory = this.options[this.selectedIndex].text;
            document.getElementById('selected-category').textContent = selectedCategory;
            document.getElementById('category-name').textContent = selectedCategory;
            
            // ‰ΩøÁî®ÈªòËÆ§‰ª∑Ê†ºÂª∫ËÆÆÂáΩÊï∞
            useDefaultSuggestions(this.value);
        });

        // Êñá‰ª∂‰∏ä‰º†È¢ÑËßàÂäüËÉΩ
        // ÂõæÁâá‰∏ä‰º†Â§ÑÁêÜÂáΩÊï∞
        function handleFileUpload(input, slot) {
            const file = input.files[0];
            if (!file) {
                console.log('‚ùå No file selected');
                return;
            }

            console.log(`üìÅ Processing file: ${file.name}, size: ${(file.size / 1024 / 1024).toFixed(2)}MB, type: ${file.type}`);

            // È™åËØÅÊñá‰ª∂Á±ªÂûã
            if (!file.type.startsWith('image/')) {
                console.log('‚ùå Invalid file type:', file.type);
                showErrorMessage('ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑÂõæÁâáÊñá‰ª∂');
                input.value = '';
                return;
            }

            // È™åËØÅÊñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂‰∏∫5MBÔºâ
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                console.log('‚ùå File too large:', file.size);
                showErrorMessage('ÂõæÁâáÊñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá5MB');
                input.value = '';
                return;
            }

            console.log('‚úÖ File validation passed');

            // ÊòæÁ§∫È¢ÑËßà
            const reader = new FileReader();
            reader.onload = function(e) {
                // ‰øùÂ≠òÂΩìÂâçÁöÑinputÂÖÉÁ¥†ÔºàÂ∞±ÊòØ‰º†ÂÖ•ÁöÑinputÂèÇÊï∞Ôºâ
                const inputClone = input.cloneNode(true);
                inputClone.style.display = 'none'; // ÈöêËóè‰ΩÜ‰øùÁïôÊñá‰ª∂
                
                // Ê∏ÖÈô§ÂéüÊúâÂÜÖÂÆπ
                slot.innerHTML = '';
                
                // ÈáçÊñ∞Ê∑ªÂä†inputÂÖÉÁ¥†Ôºà‰øùÊåÅÊñá‰ª∂ÈÄâÊã©Áä∂ÊÄÅÔºâ
                slot.appendChild(inputClone);
                
                // ÂàõÂª∫È¢ÑËßàÂÆπÂô®
                const previewContainer = document.createElement('div');
                previewContainer.style.cssText = `
                    position: relative;
                    width: 100%;
                    height: 100%;
                    background-image: url(${e.target.result});
                    background-size: cover;
                    background-position: center;
                    border-radius: 8px;
                    overflow: hidden;
                `;
                
                // ÂàõÂª∫Âà†Èô§ÊåâÈíÆ
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '√ó';
                deleteBtn.style.cssText = `
                    position: absolute;
                    top: 5px;
                    right: 5px;
                    width: 24px;
                    height: 24px;
                    border: none;
                    border-radius: 50%;
                    background: rgba(255, 0, 0, 0.8);
                    color: white;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10;
                `;
                
                deleteBtn.onclick = function(e) {
                    e.stopPropagation();
                    clearImageSlot(input, slot);
                };
                
                // ÂàõÂª∫ÊàêÂäüÊ†áËØÜ
                const successIcon = document.createElement('div');
                successIcon.innerHTML = '‚úì';
                successIcon.style.cssText = `
                    position: absolute;
                    bottom: 5px;
                    right: 5px;
                    background: rgba(0, 128, 0, 0.8);
                    color: white;
                    padding: 2px 6px;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: bold;
                `;
                
                // Ê∑ªÂä†ÂÖÉÁ¥†Âà∞ÂÆπÂô®
                previewContainer.appendChild(deleteBtn);
                previewContainer.appendChild(successIcon);
                slot.appendChild(previewContainer);
                
                // Êõ¥Êñ∞slotÊ†∑Âºè
                slot.style.border = '2px solid #28a745';
                slot.style.cursor = 'default';
                
                console.log(`üñºÔ∏è ÂõæÁâáÈ¢ÑËßàÂä†ËΩΩÊàêÂäü: ${file.name}, Â§ßÂ∞è: ${(file.size / 1024 / 1024).toFixed(2)}MB`);
                console.log(`üìÇ Input element preserved: ID=${inputClone?.id}, files count=${inputClone?.files?.length || 0}`);
            };
            
            reader.onerror = function() {
                showErrorMessage('ÂõæÁâáËØªÂèñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                input.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        // Ê∏ÖÈô§ÂõæÁâáÊßΩ
        function clearImageSlot(input, slot) {
            // Êü•ÊâæÂπ∂Ê∏ÖÈô§inputÂÖÉÁ¥†
            const fileInput = slot.querySelector('input[type="file"]') || input;
            if (fileInput) {
                fileInput.value = '';
            }
            
            // ÈáçÁΩÆslotÂÜÖÂÆπ‰∏∫ÂéüÂßãÁä∂ÊÄÅ
            const slotId = slot.id || slot.className;
            const inputId = fileInput?.id || `file-input-${slotId.match(/\d+/)?.[0] || '1'}`;
            
            slot.innerHTML = `
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none">
                    <path d="M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 15V3" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <input type="file" id="${inputId}" accept="image/*" style="display: none;">
            `;
            
            slot.style.border = '2px dashed #ddd';
            slot.style.cursor = 'pointer';
            slot.style.backgroundImage = 'none';
            
            console.log('ÂõæÁâáÊßΩÂ∑≤Ê∏ÖÈô§');
            
            // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®
            initFileUploadListeners();
        }

        // Ëé∑ÂèñÂ∑≤ÈÄâÊã©ÁöÑÂõæÁâáÊñá‰ª∂
        function getSelectedImages() {
            const images = [];
            for (let i = 1; i <= 8; i++) {
                const fileInput = document.getElementById(`file-input-${i}`);
                if (fileInput && fileInput.files && fileInput.files[0]) {
                    images.push({
                        index: i,
                        file: fileInput.files[0],
                        isPrimary: i === 1
                    });
                }
            }
            return images;
        }

        // È™åËØÅÂõæÁâáÈÄâÊã©
        function validateImageSelection() {
            const selectedImages = getSelectedImages();
            if (selectedImages.length === 0) {
                showErrorMessage('Please upload at least one image');
                return false;
            }
            return true;
        }

        // ‰∏∫ÊØè‰∏™Êñá‰ª∂ËæìÂÖ•Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
        function initFileUploadListeners() {
            for (let i = 1; i <= 8; i++) {
                const fileInput = document.getElementById(`file-input-${i}`);
                const slot = fileInput?.parentNode;
                
                if (fileInput && slot) {
                    // Êñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂
                    fileInput.addEventListener('change', function(e) {
                        handleFileUpload(this, slot);
                    });
                    
                    // ÊãñÊãΩ‰∏ä‰º†ÊîØÊåÅ
                    slot.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        this.style.borderColor = '#007bff';
                        this.style.backgroundColor = '#f8f9fa';
                    });
                    
                    slot.addEventListener('dragleave', function(e) {
                        e.preventDefault();
                        this.style.borderColor = '#ddd';
                        this.style.backgroundColor = 'transparent';
                    });
                    
                    slot.addEventListener('drop', function(e) {
                        e.preventDefault();
                        this.style.borderColor = '#ddd';
                        this.style.backgroundColor = 'transparent';
                        
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            fileInput.files = files;
                            handleFileUpload(fileInput, slot);
                        }
                    });
                }
            }
            
            console.log('Image upload listeners initialized');
        }
        
        // ÂàùÂßãÂåñÊñá‰ª∂‰∏ä‰º†ÁõëÂê¨Âô®
        initFileUploadListeners();
    </script>
</body>
</html>